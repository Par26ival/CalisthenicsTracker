<% admin_rating = @post.ratings.find_by(user: current_user) if current_user.admin? %>

<div class="w-full max-w-xl bg-white border rounded-lg p-6 shadow-sm mb-6">
  <div class="flex justify-between text-sm text-gray-500 mb-4">
    <strong class="text-gray-800"><%= @post.user.username %></strong>
    <span><%= time_ago_in_words(@post.created_at) %> ago</span>
  </div>

  <p class="text-gray-800 whitespace-pre-line">
    <%= @post.content %>
  </p>

  <% if @post.media.attached? %>
    <div class="mt-4 space-y-3">
      <% @post.media.each do |file| %>
        <% if file.image? %>
          <%= image_tag file, class: "max-w-full rounded" %>
        <% elsif file.video? %>
          <%= video_tag file, controls: true, class: "max-w-full rounded" %>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>

<div class="w-full max-w-xl mb-6">
  <% if @post.average_rating %>
    <p class="text-yellow-600 font-semibold mb-2">
      ⭐ Average rating: <%= @post.average_rating %> / 5
      (<%= @post.ratings.count %> ratings)
    </p>
  <% else %>
    <p class="text-gray-500 italic mb-2">No ratings yet</p>
  <% end %>

  <% if current_user.admin? %>
    <div class="bg-yellow-50 border rounded p-4">
      <% if admin_rating %>
        <h3 class="font-semibold mb-2">Your rating</h3>

        <p class="mb-2">
          ⭐ <strong><%= admin_rating.score %></strong> / 5
        </p>

        <% if admin_rating.comment.present? %>
          <p class="text-sm mb-3 whitespace-pre-line">
            <%= admin_rating.comment %>
          </p>
        <% end %>

        <details>
          <summary class="cursor-pointer text-sm text-blue-600 hover:underline">
            Edit rating
          </summary>

          <div class="mt-3">
            <%= form_with url: post_ratings_path(@post), method: :post, scope: :rating, local: true do |f| %>
              <div class="mb-3">
                <%= f.label :score, "Score (1–5)", class: "block text-sm font-medium" %>
                <%= f.select :score,
                      options_for_select(1..5, admin_rating.score),
                      {},
                      class: "border rounded p-2 w-full" %>
              </div>

              <div class="mb-3">
                <%= f.text_area :comment,
                      rows: 2,
                      placeholder: "Optional rating comment",
                      class: "w-full border rounded p-2" %>
              </div>

              <%= f.submit "Update rating",
                    class: "bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600" %>
            <% end %>
          </div>
        </details>
      <% else %>
        <h3 class="font-semibold mb-2">Rate this post</h3>

        <%= form_with model: [@post, Rating.new], local: true do |f| %>
          <div class="mb-3">
            <%= f.label :score, "Score (1–5)", class: "block text-sm font-medium" %>
            <%= f.select :score,
                  options_for_select(1..5),
                  {},
                  class: "border rounded p-2 w-full" %>
          </div>

          <div class="mb-3">
            <%= f.text_area :comment,
                  rows: 2,
                  placeholder: "Optional rating comment",
                  class: "w-full border rounded p-2" %>
          </div>

          <%= f.submit "Submit rating",
                class: "bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600" %>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>

<% if @post.ratings.any? %>
  <div class="w-full max-w-xl mb-6">
    <h3 class="font-semibold mb-2">Ratings</h3>

    <% @post.ratings.each do |rating| %>
      <div class="border rounded p-3 mb-2 bg-yellow-50">
        <div class="text-sm text-gray-700">
          <strong><%= rating.user.username %></strong>
          — ⭐ <%= rating.score %>/5
        </div>

        <% if rating.comment.present? %>
          <p class="text-sm mt-1 whitespace-pre-line">
            <%= rating.comment %>
          </p>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>

<h2 class="text-lg font-semibold mb-4">Comments</h2>

<div class="space-y-3 mb-6">
  <% @post.comments.each do |comment| %>
    <div class="bg-gray-50 border rounded p-3">
      <div class="text-sm text-gray-600 mb-1 flex justify-between">
        <span>
          <strong><%= comment.user.username %></strong>
          · <%= time_ago_in_words(comment.created_at) %> ago
        </span>

        <% if current_user.admin? || comment.user == current_user %>
          <%= button_to "Delete",
                post_comment_path(@post, comment),
                method: :delete,
                data: { confirm: "Delete this comment?" },
                class: "text-red-600 text-sm" %>
        <% end %>
      </div>

      <p class="whitespace-pre-line">
        <%= comment.content %>
      </p>
    </div>
  <% end %>
</div>

<%= form_with model: [@post, @comment], class: "w-full max-w-xl" do |f| %>
  <div class="mb-3">
    <%= f.text_area :content,
        rows: 3,
        placeholder: "Write a comment...",
        class: "w-full border rounded p-2" %>
  </div>

  <%= f.submit "Comment",
      class: "bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" %>
<% end %>

<% if current_user.admin? || @post.user == current_user %>
  <%= button_to "Delete Post",
        post_path(@post),
        method: :delete,
        data: { confirm: "Are you sure?" },
        class: "bg-red-600 text-white px-4 py-2 rounded mb-4" %>
<% end %>
