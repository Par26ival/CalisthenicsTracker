<h1 class="text-4xl font-bold mb-6">Calisthenics Tracker</h1>


<% if user_signed_in? %>

  <div class="w-full flex justify-between items-center mb-10">

    <div class="text-xl font-semibold">
      You are logged in as <strong><%= current_user.username %></strong>
    </div>

    <%= render "shared/profile_dropdown" %>

  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-10 w-full">

    <!-- FIND FRIENDS PANEL -->
    <div class="bg-white shadow-lg rounded-xl p-6 mt-6">
      <h2 class="text-xl font-bold mb-4">Find Friends</h2>

      <%= form_with url: users_path, method: :get, class: "flex gap-2 mb-4" do %>
        <%= text_field_tag :query,
              params[:query],
              placeholder: "Search users by name or email",
              class: "border p-2 rounded w-full" %>

        <%= submit_tag "Search",
              class: "bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" %>
      <% end %>

      <%= link_to "View all users →",
                  users_path,
                  class: "text-blue-600 hover:underline" %>
    </div>

    <div class="bg-white shadow-lg rounded-xl p-6 mt-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Skills Overview</h2>

        <%= link_to "View all",
              skills_path,
              class: "text-sm text-indigo-600 hover:underline font-medium" %>
      </div>

      <% skills = Skill
            .left_joins(:posts)
            .select(
              "skills.*,
              COUNT(CASE WHEN posts.user_id = #{ActiveRecord::Base.connection.quote(current_user.id)} THEN 1 END) AS user_attempts_count"
            )
            .group("skills.id")
            .order(Arel.sql("user_attempts_count DESC, skills.name ASC"))
            .limit(5) %>

      <% if skills.any? %>
        <% skills.each do |skill| %>
          <% attempts = skill.attributes["user_attempts_count"].to_i %>

          <div class="flex justify-between items-center mb-3">
            <div>
              <strong class="text-gray-800"><%= skill.name %></strong>
              <div class="text-sm text-gray-500">
                Your attempts: <%= attempts %>
                <% if skill.weighted_score %>
                  · ⭐ <%= skill.weighted_score %> / 5
                <% end %>
              </div>
            </div>

            <%= link_to "View",
                  skill_path(skill),
                  class: "px-3 py-1 rounded bg-gray-100 text-gray-700 hover:bg-gray-200 text-sm" %>
          </div>
        <% end %>
      <% else %>
        <p class="text-gray-500 italic">
          No skills available yet.
        </p>
      <% end %>
    </div>

    <div class="bg-white shadow-lg rounded-xl p-6 min-h-[400px]">
      <h2 class="text-2xl font-bold mb-4">Upload / View posts</h2>

      <%= link_to "Posts",
                  posts_path,
                  class: "block bg-blue-600 text-white py-2 px-4 rounded text-center hover:bg-blue-700" %>
    </div>

  </div>

<% else %>
  <div class="flex gap-6">
    <%= link_to "Login",
                login_path,
                class: "bg-blue-600 text-white px-6 py-2 rounded text-xl" %>

    <%= link_to "Register",
                register_path,
                class: "bg-green-600 text-white px-6 py-2 rounded text-xl" %>
  </div>

  <%= render "logged_out_home" if lookup_context.exists?("logged_out_home", "home_page") %>
<% end %>
